<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Image Upload</title>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #020202; color: #Eaeaea;
            font-family: 'Shippori Mincho', serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; text-align: center;
            padding: 20px; box-sizing: border-box;
            padding-bottom: 60px; /* Footer space */
        }
        h2 { color: #D4AF37; margin-bottom: 20px; letter-spacing: 0.1em; }
        
        #main-content {
            width: 100%; max-width: 400px;
            display: flex; flex-direction: column; align-items: center;
        }

        .file-box {
            border: 1px dashed #333; 
            width: 100%; height: 250px; 
            display: flex; justify-content: center; align-items: center;
            color: #888; transition: 0.3s; cursor: pointer;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.02);
            position: relative; overflow: hidden; border-radius: 4px;
        }
        .file-box:hover { border-color: #D4AF37; color: #D4AF37; background: rgba(212, 175, 55, 0.05); }
        
        #preview-img {
            max-width: 100%; max-height: 100%;
            object-fit: contain; display: none; z-index: 2;
        }
        .file-box.has-image { border-style: solid; border-color: #D4AF37; }

        .placeholder-text { font-size: 1rem; pointer-events: none; z-index: 1; }

        .btn {
            background: transparent; border: 1px solid #D4AF37; color: #D4AF37;
            padding: 15px 60px; font-size: 1rem; letter-spacing: 0.2em;
            cursor: pointer; transition: 0.3s; margin-top: 10px; width: 80%;
        }
        .btn:active { background: #D4AF37; color: #000; }
        .btn:disabled { border-color: #555; color: #555; pointer-events: none; }

        /* ABOUT Button (on Success) */
        .btn-about {
            margin-top: 30px;
            font-size: 0.9rem; border-bottom: 1px solid #666; 
            padding-bottom: 2px; color: #888; border: none; background: none;
            cursor: pointer; transition: 0.3s;
        }
        .btn-about:hover { color: #D4AF37; }

        /* Social Icons */
        .social-links {
            margin-top: 30px; display: flex; gap: 20px; justify-content: center;
        }
        .social-icon {
            width: 24px; height: 24px; fill: #666; transition: 0.3s;
        }
        .social-links a:hover .social-icon { fill: #D4AF37; transform: scale(1.1); }
        
        /* 完了画面用の画像 */
        #sent-result-img {
            max-width: 80%; max-height: 200px;
            margin-top: 20px; 
            margin-left: auto; margin-right: auto;
            border: 1px solid #D4AF37; display: none;
        }

        /* Footer */
        .main-footer {
            position: fixed; bottom: 15px; left: 0; width: 100%;
            text-align: center; font-size: 0.6rem; color: #444;
            pointer-events: none; z-index: 5; font-family: sans-serif; letter-spacing: 0.1em;
        }

        /* ABOUT Overlay (Mobile) */
        .overlay-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(5px);
            z-index: 999; display: none; opacity: 0; transition: opacity 0.5s;
            flex-direction: column; align-items: center;
            padding-top: 40px; box-sizing: border-box;
        }
        .overlay-container.show { display: flex; opacity: 1; }
        
        .overlay-content {
            width: 90%; max-width: 600px; height: 80vh; 
            display: flex; flex-direction: column;
            color: #ccc; text-align: left;
        }
        
        /* Tab Styles (Copied) */
        .tab-header { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .tab-btn { background: transparent; border: none; color: #666; font-family: 'Shippori Mincho', serif; font-size: 1rem; cursor: pointer; transition: 0.3s; position: relative; }
        .tab-btn.active { color: #D4AF37; }
        .tab-body { overflow-y: auto; padding: 10px; line-height: 1.8; font-size: 0.9rem; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        
        .close-btn { margin-top: 20px; color: #fff; font-size: 2rem; cursor: pointer; background: none; border: none; }

        .hidden { display: none !important; }
        .lang-en { display: none; }
    </style>
</head>
<body class="lang-jp">

    <div id="main-content">
        <h2 class="lang-jp">画像の奉納</h2>
        <h2 class="lang-en">Image Offering</h2>
        
        <p class="lang-jp" style="color:#666; font-size:0.8rem; margin-bottom:30px;">
            タップして写真を選択してください
        </p>
        <p class="lang-en" style="color:#666; font-size:0.8rem; margin-bottom:30px;">
            Tap to select an image
        </p>

        <label for="file-upload" class="file-box" id="file-label">
            <span class="placeholder-text" id="placeholder">+ Select Image</span>
            <img id="preview-img" src="" alt="preview">
        </label>
        <input id="file-upload" type="file" style="display:none" accept="image/*">

        <button class="btn lang-jp" onclick="uploadImage()">送信</button>
        <button class="btn lang-en" onclick="uploadImage()">SEND</button>
    </div>

    <div id="success-msg" class="hidden">
        <h2 class="lang-jp" style="font-size:1.5rem; margin-top: 20px;">奉納完了</h2>
        <h2 class="lang-en" style="font-size:1.5rem; margin-top: 20px;">Received</h2>
        
        <p class="lang-jp" style="line-height: 2;">
            画像が転送されました。<br>タブレットの画面をご確認ください。
        </p>
        <p class="lang-en" style="line-height: 2;">
            Image transferred successfully.<br>Please check the tablet screen.
        </p>
        
        <img id="sent-result-img" src="">

        <button class="btn-about lang-jp" onclick="toggleOverlay(true)">この作品について</button>
        <button class="btn-about lang-en" onclick="toggleOverlay(true)">About this work</button>

        <div class="social-links">
            <a href="https://www.instagram.com/gokurakufinearts?igsh=MWl6OW42OWY1NXc3OA==" target="_blank">
                <svg class="social-icon" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
            </a>
            <a href="https://x.com/gkrkfnrts?s=21&t=ceUsSg-0HWykVFFYJs2LZA" target="_blank">
                <svg class="social-icon" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            </a>
            <a href="https://www.gokurakufinearts.com/" target="_blank">
                <svg class="social-icon" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm1 16.057v-3.057h-2v3.057c-2.316-.252-4.305-1.536-5.592-3.492l1.396-1.396c.666 1.054 1.677 1.832 2.89 2.121v-8.582c-1.213.289-2.224 1.067-2.89 2.121l-1.396-1.396c1.287-1.956 3.276-3.24 5.592-3.492v3.057h2v-3.057c2.316.252 4.305 1.536 5.592 3.492l-1.396 1.396c-.666-1.054-1.677-1.832-2.89-2.121v8.582c1.213-.289 2.224-1.067 2.89-2.121l1.396 1.396c-1.287 1.956-3.276 3.24-5.592 3.492z"/></svg>
            </a>
            <a href="https://gkrkfnrts.official.ec/" target="_blank">
                <svg class="social-icon" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
            </a>
        </div>
    </div>

    <div id="mobile-overlay" class="overlay-container">
        <div class="overlay-content">
            <div class="tab-header">
                <button class="tab-btn active" onclick="switchTab('concept')">Concept</button>
                <button class="tab-btn" onclick="switchTab('explanation')">Explanation</button>
            </div>
            
            <div id="overlay-scroll-area" class="tab-body">
                <div id="tab-concept" class="tab-pane active">
                    <h3 class="lang-jp">Core Concept</h3>
                    <h3 class="lang-en">Core Concept</h3>
                    
                    <p class="lang-jp">
                        二畳の茶室「量子庵」の掛軸型モニターは、此岸と彼岸のあわいに口をひらくポータルとして機能する。鑑賞者が記憶や選択を奉納すると、AIは人間には辿り着けない計算の暗がりで仮想浄土を構築し、その内部に一度きりの記号的自己像〈Karma Portrait〉を刻む。<br><br>
                        そこに立ち上がるのは、言語化以前に身体が抱え込んだ感情や欲望が、光とノイズのうねりとして析出した風景であり、観る者はアイデンティティという記号をいったん手放し、その像に自らの「どこへ還るか」という感覚を静かに促す。
                    </p>
                    <p class="lang-en">
                        In the two-mat tea room <i>Ryōshi-an</i>, a hanging-scroll–shaped monitor functions as a portal opening onto the interval between this shore and the other. When a viewer offers memories and choices, AI constructs a virtual Pure Land within a computational darkness humans cannot traverse, and inscribes within it a one-time semiotic self-image: Karma Portrait.<br><br>
                        What comes into being is a landscape in which emotions and desires—incorporated by the body prior to articulation—condense into swells of light and noise. The viewer is invited to relinquish the sign called “identity,” and to confront the image not as participation but as calibration: a quiet alignment with an embodied sense of “where one might return.”
                    </p>
                </div>
                <div id="tab-explanation" class="tab-pane">
                    <h4 class="lang-jp">量子庵</h4>
                    <h4 class="lang-en"><i>Ryōshi-an</i></h4>
                    <p class="lang-jp">
                        二畳という最小の器に、最大の遠さを折り畳むための名である。<br>
                        量子とは、世界が連続ではなく、跳躍と確率で編まれているという感触の別名だ。量子庵は、過剰な情報から距離を取り、むしろ「演算だけが届く彼岸」を迎え入れるための暗室として設計される。光が少ないほど、像は強くなる。静けさが深いほど、閾値は薄くなる。
                    </p>
                    <p class="lang-en">
                        <i>Ryōshi-an</i> names an attempt to fold maximal distance into a minimal vessel: a two-mat room.<br>
                        “Quantum,” here, does not designate mere futurism; it refers to a tactile intuition that the world is not continuous, but woven from discontinuities—jumps, thresholds, probabilities. Designed as a darkroom, <i>Ryōshi-an</i> withdraws from the saturation of information and instead admits an “other shore” that arrives only through computation. The less light the room contains, the more forcefully the image asserts itself; the deeper the quiet, the thinner the threshold becomes.
                    </p>

                    <h4 class="lang-jp">Karma Portrait</h4>
                    <h4 class="lang-en">Karma Portrait</h4>
                    <p class="lang-jp">
                        これは“顔”ではない。自己の似姿でもない。<br>
                        鑑賞者が差し出す記憶や選択は、人格の説明ではなく、業としての偏りとして扱われる。Karma Portraitは、その偏りが映像の秩序へと翻訳された、一度きりの記号的自己像である。言語化以前に身体が抱え込んだ輪郭が、光とノイズのうねりとして析出し、像になる。
                    </p>
                    <p class="lang-en">
                        Karma Portrait is neither a face nor a likeness.<br>
                        The viewer’s memories and choices are treated not as a psychological profile, but as karmic bias—an asymmetry, a tilt, a predisposition that precedes explanation. Karma Portrait is the one-time semiotic self-image produced when that bias is translated into the order of moving images. What the body held before language—its unresolved outline—precipitates as light, grain, and noise, and briefly becomes an image.
                    </p>
                </div>
            </div>
            
            <button class="close-btn" onclick="toggleOverlay(false)">×</button>
        </div>
    </div>

    <div class="main-footer">
        © 2025 KARMIC IDENTITY
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session_id');
        const lang = params.get('lang') || 'jp';

        document.body.className = 'lang-' + lang;

        const fileInput = document.getElementById('file-upload');
        const fileLabel = document.getElementById('file-label');
        const previewImg = document.getElementById('preview-img');
        const placeholder = document.getElementById('placeholder');
        const sentResultImg = document.getElementById('sent-result-img');

        // 言語設定 (JS側でも制御)
        if (lang === 'en') {
            document.querySelectorAll('.lang-jp').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.lang-en').forEach(el => el.style.display = 'block');
        } else {
            document.querySelectorAll('.lang-en').forEach(el => el.style.display = 'none');
        }

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    previewImg.src = event.target.result;
                    previewImg.style.display = 'block';
                    placeholder.style.display = 'none';
                    fileLabel.classList.add('has-image');
                }
                reader.readAsDataURL(file);
            }
        });

        function compressImage(file, maxWidth) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function(event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                            resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                        }, 'image/jpeg', 0.6);
                    }
                }
            });
        }

        async function uploadImage() {
            if (!fileInput.files[0]) return alert(lang==='en' ? "Please select an image" : "画像を選択してください");
            if (!sessionId) return alert(lang==='en' ? "Session Error: Rescan QR" : "セッションエラー: QRコードを読み直してください");

            const btns = document.querySelectorAll('.btn');
            btns.forEach(b => {
                b.innerText = lang==='en' ? "Sending..." : "送信中...";
                b.disabled = true;
            });

            try {
                const compressedFile = await compressImage(fileInput.files[0], 800);
                const formData = new FormData();
                formData.append('session_id', sessionId);
                formData.append('image', compressedFile);

                const res = await fetch('/upload-satellite', { method: 'POST', body: formData });
                
                if(res.ok) {
                    sentResultImg.src = previewImg.src;
                    sentResultImg.style.display = 'block';
                    document.getElementById('main-content').classList.add('hidden');
                    document.getElementById('success-msg').classList.remove('hidden');
                } else {
                    const errText = await res.text();
                    throw new Error("Server Error: " + errText);
                }
            } catch (e) {
                console.error(e);
                alert(lang==='en' ? "Upload Failed. Please try again." : "送信に失敗しました。\n通信環境を確認して再試行してください。");
                btns.forEach(b => {
                    b.innerText = lang==='en' ? "SEND" : "送信";
                    b.disabled = false;
                });
            }
        }

        // Overlay Logic
        function toggleOverlay(show) {
            const overlay = document.getElementById('mobile-overlay');
            if(show) {
                overlay.classList.add('show');
                setTimeout(() => overlay.style.opacity = '1', 10);
            } else {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.classList.remove('show'), 500);
            }
        }

        // Tab Logic (with Scroll Reset)
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if(event && event.target) event.target.classList.add('active'); 

            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');

            const scrollArea = document.getElementById('overlay-scroll-area');
            if(scrollArea) scrollArea.scrollTop = 0;
        }
    </script>
</body>
</html>