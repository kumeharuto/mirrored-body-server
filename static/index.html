<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KARMIC IDENTITY</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500&family=Zen+Kaku+Gothic+New:wght@300;400&display=swap" rel="stylesheet">
    
    <style>
        /* === 徹底的な選択禁止 === */
        * {
            -webkit-user-select: none; user-select: none;
            -webkit-touch-callout: none;
        }
        input, textarea {
            -webkit-user-select: text !important;
            user-select: text !important;
            -webkit-touch-callout: default !important;
        }

        :root {
            --bg-color: #020202;
            --text-main: #Eaeaea;
            --text-dim: #888;
            --accent: #D4AF37;         
            --accent-glow: rgba(212, 175, 55, 0.5);
            --border: #333333;
            --font-serif: 'Shippori Mincho', serif;
            --font-sans: 'Zen Kaku Gothic New', sans-serif;
            
            /* === サイズ定義（大型化・バランス調整） === */
            --thumb-size: 36px;       /* 玉の大きさ (大きく) */
            --dot-size: 10px;         /* 目印の大きさ (大きく) */
            --track-height: 6px;      /* 棒の太さ (太く) */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-sans);
            margin: 0; padding: 0;
            min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            letter-spacing: 0.08em;
            overflow-x: hidden;
        }

        .container {
            width: 100%; max-width: 500px; padding: 40px 30px;
            position: relative; z-index: 2;
        }

        /* === アニメーション === */
        .dissolve-out {
            animation: meltOut 0.6s cubic-bezier(0.5, 0, 0.1, 1) forwards;
            pointer-events: none;
        }
        @keyframes meltOut {
            0% { opacity: 1; filter: blur(0px); transform: scale(1); }
            100% { opacity: 0; filter: blur(10px); transform: scale(1.02); }
        }

        .dissolve-in {
            display: block !important;
            animation: formIn 0.4s ease-out forwards;
        }
        @keyframes formIn {
            0% { opacity: 0; filter: blur(10px); transform: translateY(10px); }
            100% { opacity: 1; filter: blur(0px); transform: translateY(0); }
        }

        .hidden { display: none; }

        /* タイトル・テキスト */
        h1 {
            font-family: var(--font-serif); font-weight: 400; font-size: 1.6rem;
            text-align: center; margin-bottom: 40px; letter-spacing: 0.15em;
            color: var(--accent); text-shadow: 0 0 15px var(--accent-glow);
            line-height: 1.4;
        }
        h2 {
            font-family: var(--font-serif); font-size: 1.1rem; font-weight: 400; color: #fff;
            margin: 50px 0 30px 0; display: flex; align-items: center;
            border-left: 3px solid var(--accent); padding-left: 15px;
        }
        
        .concept-text {
            font-family: var(--font-serif); font-size: 0.95rem; line-height: 2.2;
            color: #ccc; margin-bottom: 60px; text-align: left;
            text-align-last: center;
        }
        .concept-text p { margin-bottom: 1.5em; }

        /* 入力エリア */
        .row-group { display: flex; gap: 20px; margin-bottom: 35px; align-items: flex-end; }
        .input-group { margin-bottom: 50px; /* スライダー間隔を少し広げる */ }
        label { display: block; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 12px; font-family: var(--font-sans); }

        .clean-input {
            width: 100%; background: transparent; border: none; border-bottom: 1px solid var(--border);
            color: #fff; padding: 10px 0; font-size: 1.1rem; font-family: var(--font-serif);
            outline: none; transition: 0.4s; border-radius: 0;
        }
        .clean-input:focus { border-bottom-color: var(--accent); }
        
        textarea.clean-area {
            width: 100%; background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            color: #fff; padding: 15px; font-size: 1rem; font-family: var(--font-serif);
            resize: none; outline: none; box-sizing: border-box; transition: 0.4s;
            line-height: 1.8; margin-top: 5px; border-radius: 2px;
        }
        textarea.clean-area:focus { border-color: var(--accent); background: rgba(212, 175, 55, 0.05); }

        /* === 修正: 完璧なスライダー === */
        .slider-wrapper {
            position: relative;
            height: 50px;
            width: 100%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        
        .slider-labels {
            display: flex; justify-content: space-between;
            font-size: 0.8rem; color: var(--text-dim); margin-bottom: 5px;
            font-family: var(--font-serif);
        }

        /* ★目印(Dots)コンテナ 兼 ビジュアルトラック
           - 幅を「100% - 玉サイズ」にすることで、玉の中心の可動域と完全に一致させる
           - 中央配置 (margin: auto)
        */
        .slider-visual-track {
            position: absolute;
            left: 0; right: 0; margin: auto;
            width: calc(100% - var(--thumb-size)); 
            height: var(--thumb-size);
            pointer-events: none; /* クリックはinputに通す */
            display: flex; justify-content: space-between; align-items: center;
            z-index: 0;
        }

        /* ★自前の棒を描画 (Dotsコンテナの中に線を引く)
           これにより「目印から目印まで」しか棒が存在しない状態を作る */
        .slider-visual-track::before {
            content: '';
            position: absolute;
            width: 100%;
            height: var(--track-height);
            background: var(--accent); /* 純金 (透明度なし) */
            border-radius: 4px;
            left: 0; top: 50%; transform: translateY(-50%);
            z-index: -1;
        }

        /* 目印（丸い点） */
        .dot {
            width: var(--dot-size); height: var(--dot-size);
            background: #222; /* 未選択時は黒っぽくして棒の上にのせる */
            border: 2px solid var(--accent); /* 金色の縁取り */
            border-radius: 50%;
            transition: all 0.2s ease;
            box-sizing: border-box;
            position: relative; z-index: 1;
        }
        /* 選択時 */
        .dot.active {
            background: var(--accent);
            box-shadow: 0 0 10px var(--accent);
            transform: scale(1.3);
        }

        /* Input Range 本体 */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%; /* 親要素いっぱい */
            background: transparent;
            position: relative;
            z-index: 2;
            margin: 0;
            height: 100%;
        }

        /* ブラウザ標準の棒を消す (透明にする) */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 100%;
            background: transparent; /* 透明！ */
            border: none;
        }

        /* ツマミ（玉） */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            border: none; 
            height: var(--thumb-size); width: var(--thumb-size);
            border-radius: 50%;
            background: var(--accent); /* 金色 */
            cursor: pointer;
            /* 垂直中央寄せの計算 */
            margin-top: calc((50px - var(--thumb-size)) / 2); /* Wrapper高さ(50)基準で中央へ */
            box-shadow: 0 0 15px var(--accent-glow);
            transition: transform 0.1s;
        }
        input[type=range]:active::-webkit-slider-thumb {
            transform: scale(1.1);
            background: #FFF; /* タップ反応 */
        }

        /* File Upload & Button */
        .file-box {
            display: block; padding: 30px; text-align: center; border: 1px solid var(--border);
            color: var(--text-dim); font-size: 0.9rem; cursor: pointer; transition: 0.4s;
            font-family: var(--font-sans);
        }
        .file-box:hover { border-color: var(--accent); color: var(--accent); background: rgba(212, 175, 55, 0.05); }

        .btn-entry {
            background: transparent; border: 1px solid var(--accent); color: var(--accent);
            padding: 20px 0; width: 100%; font-family: var(--font-serif); font-size: 1.1rem;
            letter-spacing: 0.3em; cursor: pointer; transition: all 0.3s ease;
            position: relative; overflow: hidden;
            margin-top: 50px;
        }
        .btn-entry:hover { background: var(--accent); color: #000; box-shadow: 0 0 25px var(--accent-glow); }

        /* Overlay */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 999; opacity: 0; pointer-events: none; transition: 0.8s;
        }
        .loading-text {
            font-family: var(--font-serif); font-size: 1.2rem; letter-spacing: 0.2em;
            color: var(--accent); margin-bottom: 20px; text-align: center; line-height: 2;
        }
        .blink { animation: breathe 2s infinite ease-in-out; }
        @keyframes breathe { 0%,100% { opacity: 0.4; } 50% { opacity: 1; } }

    </style>
</head>
<body>

    <div class="container">
        
        <div id="landing-page">
            <h1>KARMIC IDENTITY</h1>
            <div class="concept-text">
                <p>
                ここでは、いくつかの問いに答えることで、<br>
                あなたの記憶や心の在り方から<br>
                「Karmic Identity（業報の自己像）」をかたちづくります。
                </p>
                <p>
                入力された言葉や選択は、ひとつの輪廻として再構成され、<br>
                泡影庵の掛け軸に、一度きりの映像として立ち上がる<br>
                「あなただけの浄土」となります。
                </p>
                <p>
                本名や連絡先は必要ありません。<br>
                いまのあなたに近いと思うものを、<br>
                直感で入力し、選んでください。<br>
                ここで生まれた「あなたの業のかたち」を、<br>
                この場限りのものとして、そっと手放してみてください。
                </p>
            </div>
            <button class="btn-entry" onclick="goToForm()">ENTRY</button>
        </div>

        <div id="form-page" class="hidden">
            <h1>PROFILE</h1>
            
            <div class="row-group">
                <div style="flex: 2;">
                    <label>コードネーム</label>
                    <input type="text" class="clean-input" placeholder="">
                </div>
                <div style="flex: 1;">
                    <label>年齢</label>
                    <input type="number" class="clean-input" placeholder="">
                </div>
            </div>

            <h2>SENSE</h2>
            
            <div class="input-group">
                <div class="slider-labels"><span>海 (Sea)</span><span>山 (Mountain)</span></div>
                <div class="slider-wrapper">
                    <div class="slider-visual-track">
                        <span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    </div>
                    <input type="range" min="0" max="4" step="1" value="2" oninput="updateDots(this)">
                </div>
            </div>

            <div class="input-group">
                <div class="slider-labels"><span>静寂 (Silence)</span><span>喧騒 (Noise)</span></div>
                <div class="slider-wrapper">
                    <div class="slider-visual-track">
                        <span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    </div>
                    <input type="range" min="0" max="4" step="1" value="2" oninput="updateDots(this)">
                </div>
            </div>

            <div class="input-group">
                <div class="slider-labels"><span>深淵 (Dark)</span><span>救済 (Light)</span></div>
                <div class="slider-wrapper">
                    <div class="slider-visual-track">
                        <span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    </div>
                    <input type="range" min="0" max="4" step="1" value="2" oninput="updateDots(this)">
                </div>
            </div>

            <h2>MIND DIVE</h2>
            <div class="input-group">
                <label>心象風景の描写</label>
                <textarea class="clean-area" rows="5" placeholder="今、見えている色や形を言葉にしてください..."></textarea>
            </div>
            <div class="input-group">
                <label>記憶の欠片</label>
                <textarea class="clean-area" rows="3" placeholder="消えない記憶、あるいは予感について..."></textarea>
            </div>
            <div class="input-group">
                <label>意識の流れ</label>
                <textarea class="clean-area" rows="2" placeholder="浮かんでくる言葉を3つ..."></textarea>
            </div>

            <div class="input-group" style="margin-top:40px;">
                <label style="margin-bottom:15px; display:block;">画像の奉納 (任意)</label>
                <label for="file-upload" class="file-box">+ Select Image</label>
                <input id="file-upload" type="file" style="display:none" accept="image/*">
            </div>

            <button class="btn-entry" onclick="submitForm()">INITIATE</button>
        </div>
    </div>

    <div id="loading-overlay">
        <div id="status-text" class="loading-text blink">紐解いています...</div>
    </div>

    <script>
        const WAIT_TIME = 30; 

        document.addEventListener('DOMContentLoaded', function() {
            
            // ① 高速化した遷移アニメーション
            window.goToForm = function() {
                const landing = document.getElementById('landing-page');
                const form = document.getElementById('form-page');
                
                // 1. 消える
                landing.classList.add('dissolve-out');
                
                // 2. 0.6秒待つ
                setTimeout(() => {
                    landing.classList.add('hidden'); 
                    form.classList.remove('hidden'); 
                    form.classList.add('dissolve-in'); 
                    window.scrollTo(0,0);
                }, 550); 
            };

            // 目盛り(Dots)制御
            window.updateDots = function(rangeInput) {
                const wrapper = rangeInput.closest('.slider-wrapper');
                const dots = wrapper.querySelectorAll('.dot');
                const val = parseInt(rangeInput.value);
                
                dots.forEach((dot, index) => {
                    if (index === val) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            };

            // 初期化
            document.querySelectorAll('input[type=range]').forEach(input => updateDots(input));


            // ファイル選択
            const fileInput = document.getElementById('file-upload');
            if (fileInput) {
                fileInput.addEventListener('change', function(e){
                    const fileName = e.target.files[0] ? e.target.files[0].name : "+ Select Image";
                    const fileBox = document.querySelector('.file-box');
                    if (fileBox) {
                        fileBox.innerText = fileName;
                        fileBox.style.borderColor = "#D4AF37";
                    }
                });
            }

            // 画像圧縮用の関数（新規追加）
            function compressImage(file, maxWidth) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = function(event) {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;

                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // JPEG品質 0.7 (70%) で圧縮
                            canvas.toBlob((blob) => {
                                // 元のファイル名を引き継いで新しいFileオブジェクトを作る
                                const newFile = new File([blob], file.name, { type: 'image/jpeg' });
                                resolve(newFile);
                            }, 'image/jpeg', 0.7);
                        }
                    }
                });
            }

            // 送信処理（圧縮ロジック追加版）
            window.submitForm = async function() {
                const overlay = document.getElementById('loading-overlay');
                const statusText = document.getElementById('status-text');
                
                if(overlay) {
                    overlay.style.opacity = '1';
                    overlay.style.pointerEvents = 'auto';
                    statusText.innerText = "紐解いています...";
                    statusText.classList.add('blink');
                }

                const inputs = document.querySelectorAll('.clean-input');
                const sliders = document.querySelectorAll('input[type=range]');
                const areas = document.querySelectorAll('.clean-area');
                const fileInput = document.getElementById('file-upload');
                let file = fileInput ? fileInput.files[0] : null;

                // ★ここで画像を圧縮！
                if (file) {
                    statusText.innerText = "記憶を圧縮しています..."; // 演出用テキスト
                    try {
                        // 最大幅1000pxにリサイズ
                        file = await compressImage(file, 1000);
                    } catch (e) {
                        console.error("Compression failed", e);
                    }
                }
                statusText.innerText = "紐解いています...";

                const formData = new FormData();
                formData.append('codename', inputs[0].value || "Unknown");
                formData.append('age', inputs[1].value || "0"); // 文字列として送る
                formData.append('sense_sea_mt', sliders[0].value);
                formData.append('sense_quiet_noise', sliders[1].value);
                formData.append('sense_dark_light', sliders[2].value);
                formData.append('desc_imagery', areas[0].value || "");
                formData.append('desc_memory', areas[1].value || "");
                formData.append('desc_stream', areas[2].value || "");
                
                if (file) formData.append('image', file);

                try {
                    const response = await fetch('/submit', { method: 'POST', body: formData });

                    if (response.ok) {
                        statusText.classList.remove('blink');
                        statusText.innerHTML = `奉納されました。<br>生成を開始します。<br><br>あと ${WAIT_TIME} 秒お待ちください`;
                        
                        let count = WAIT_TIME;
                        const timer = setInterval(() => {
                            count--;
                            if(count <= 0) {
                                clearInterval(timer);
                                location.reload(); 
                            } else {
                                statusText.innerHTML = `奉納されました。<br>生成を開始します。<br><br>あと ${count} 秒お待ちください`;
                            }
                        }, 1000);

                    } else {
                        alert("送信エラー: サーバーが混み合っている可能性があります");
                        if(overlay) overlay.style.opacity = '0';
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("サーバー未接続");
                    if(overlay) overlay.style.opacity = '0';
                    overlay.style.pointerEvents = 'none';
                }
            };
        });
    </script>
</body>
</html>