<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Karma Portrait</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23D4AF37' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cline x1='2' y1='12' x2='22' y2='12'/%3E%3Cpath d='M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z'/%3E%3Cpath d='M2.93 8.8h18.14'/%3E%3Cpath d='M2.93 15.2h18.14'/%3E%3C/svg%3E">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* === RESET & BASE === */
        * { -webkit-user-select: none; user-select: none; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        input, textarea { -webkit-user-select: text !important; user-select: text !important; outline: none; }
        
        :root {
            --bg-color: #050505;
            --text-color: #ffffff;
            --border-color: #ffffff;
            --dim-color: #888888;
            --font-main: 'Shippori Mincho', serif;
            --thumb-size: 28px;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            margin: 0; padding: 0;
            min-height: 100vh;
            display: flex; justify-content: center;
            overflow-x: hidden;
        }

        /* === TEXTURE UTILITIES (マーブル模様) === */
        .marble-text {
            background-image: url('/static/texture.jpg');
            background-size: cover;
            background-position: center;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
        }
        
        .marble-bg {
            background-image: url('/static/texture.jpg');
            background-size: cover;
            background-position: center;
        }

        .container {
            width: 100%; max-width: 600px;
            padding: 20px;
            padding-top: 100px; /* Header space */
            padding-bottom: 80px; /* Footer space */
            position: relative;
        }

        /* === HEADER === */
        .header-fixed {
            position: fixed; top: 0; left: 0; width: 100%;
            height: 80px;
            background: rgba(5, 5, 5, 0.9);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .header-left button {
            background: none; border: none; color: #fff;
            font-family: var(--font-main); font-size: 1rem; cursor: pointer;
            display: flex; align-items: center; gap: 5px;
        }

        .header-title {
            font-size: 1.5rem; letter-spacing: 0.1em;
            text-align: center;
            position: absolute; left: 50%; transform: translateX(-50%);
            white-space: nowrap;
        }

        /* Language Switch (Pill Shape) */
        .lang-switch {
            display: flex;
            border: 1px solid #fff;
            border-radius: 20px;
            overflow: hidden;
            font-size: 0.8rem;
        }
        .lang-option {
            padding: 5px 12px; cursor: pointer; transition: 0.3s;
            background: #000; color: #fff;
        }
        .lang-option.active {
            background-image: url('/static/texture.jpg');
            background-size: cover;
            color: #fff; /* text-shadow might be needed depending on texture */
            font-weight: bold;
        }

        /* === SECTIONS === */
        .section-header {
            text-align: center;
            margin-top: 60px; margin-bottom: 40px;
        }
        .section-header h2 {
            font-size: 1.4rem; font-weight: 500; letter-spacing: 0.2em;
            margin: 0; color: #fff;
        }
        .section-header .sub {
            font-size: 0.8rem; color: var(--dim-color); letter-spacing: 0.1em;
            margin-top: 5px; display: block; font-family: sans-serif;
        }

        /* === INPUTS === */
        .input-group { margin-bottom: 50px; }
        .row-group { display: flex; gap: 30px; align-items: flex-end; }
        
        label {
            display: block; font-size: 0.9rem; color: #fff;
            margin-bottom: 15px; letter-spacing: 0.05em;
        }
        
        .clean-input {
            width: 100%; background: transparent;
            border: none; border-bottom: 1px solid #fff;
            color: #fff; padding: 10px 0;
            font-size: 1.2rem; font-family: var(--font-main);
            border-radius: 0;
        }
        
        .clean-area {
            width: 100%; background: transparent;
            border: 1px solid #fff;
            color: #fff; padding: 15px;
            font-size: 1rem; font-family: var(--font-main);
            resize: none; border-radius: 0;
            line-height: 1.6;
        }

        /* === CUSTOM SLIDER (Marble Style) === */
        .slider-container {
            position: relative;
            width: 100%;
            height: 60px; /* Touch area height */
            display: flex; align-items: center; justify-content: center;
        }
        
        .slider-labels {
            display: flex; justify-content: space-between;
            font-size: 0.9rem; margin-bottom: 10px;
        }

        /* Visual Track with Dots */
        .visual-track {
            position: absolute; width: 100%; height: 2px;
            background: #fff;
            top: 50%; transform: translateY(-50%);
            display: flex; justify-content: space-between; align-items: center;
            pointer-events: none; z-index: 0;
        }
        
        /* The Dots on the track */
        .track-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
            background: #000;
            border: 2px solid #fff;
            box-sizing: border-box;
        }

        /* The Input Range itself */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%; height: 100%;
            background: transparent;
            position: absolute; top: 0; left: 0;
            z-index: 2; margin: 0; cursor: pointer;
        }
        
        /* Slider Thumb (The Marble Planet) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: var(--thumb-size); width: var(--thumb-size);
            border-radius: 50%;
            background-image: url('/static/texture.jpg'); /* Texture here */
            background-size: 150%; /* Zoom in texture slightly */
            background-position: center;
            border: 2px solid #fff;
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
            transition: transform 0.1s;
        }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.2); }

        /* === BUTTONS === */
        .btn-entry {
            display: block; width: 100%; max-width: 300px; margin: 60px auto;
            padding: 20px;
            background: transparent;
            border: 1px solid #fff; /* Simple white border per image 2 */
            color: #fff;
            font-family: var(--font-main); font-size: 1.2rem; letter-spacing: 0.3em;
            cursor: pointer; position: relative; overflow: hidden;
            transition: 0.3s;
        }
        
        .btn-entry::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('/static/texture.jpg');
            background-size: cover;
            opacity: 0; transition: 0.3s; z-index: -1;
        }
        .btn-entry:hover { border-color: transparent; }
        .btn-entry:hover::before { opacity: 1; }

        /* === QR SECTION === */
        .qr-section {
            border: 1px solid #fff;
            padding: 30px; text-align: center;
            margin-top: 60px;
        }
        #qrcode { 
            background: #fff; padding: 10px; display: inline-block; 
            margin: 20px 0;
        }
        .received-thumb {
            max-width: 100%; height: auto; border: 2px solid #fff;
            margin-top: 20px; display: none;
        }

        /* === UTILS === */
        .hidden { display: none !important; }
        .lang-jp .lang-en { display: none; }
        .lang-en .lang-jp { display: none; }
        
        /* Loading Overlay */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.5s;
        }
        .loading-text { font-size: 1.5rem; letter-spacing: 0.2em; color: #fff; animation: blink 2s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

    </style>
</head>
<body class="lang-jp">

    <div class="header-fixed">
        <div class="header-left">
            <button onclick="backToTitle()" id="btn-back" class="hidden">← BACK</button>
        </div>
        <div class="header-title marble-text">KARMA PORTRAIT</div>
        <div class="header-right">
            <div class="lang-switch">
                <div id="lang-btn-jp" class="lang-option active" onclick="setLanguage('jp')">JP</div>
                <div id="lang-btn-en" class="lang-option" onclick="setLanguage('en')">EN</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="landing-page">
            <div style="height: 10vh;"></div>
            <div class="section-header">
                <h2 class="marble-text" style="font-size: 2rem;">CONCEPT</h2>
            </div>
            
            <div style="text-align: center; line-height: 2.5; font-size: 0.95rem; margin-bottom: 50px;">
                <p class="lang-jp">
                    二畳の茶室「量子庵」の掛軸型モニターは、<br>
                    此岸と彼岸のあわいにひらく小さな境界です。<br><br>
                    ここで入力される言葉と選択は、<br>
                    あなたの内側に沈んでいる記憶や癖を拾い上げるための、<br>
                    最小限の手がかりになります。<br><br>
                    AIは計算の暗がりで仮想浄土を組み上げ、<br>
                    その内部に一度きりの〈Karma Portrait〉を刻みます。
                </p>
                <p class="lang-en">
                    The hanging scroll monitor in the tea room "Ryoshi-an"<br>
                    is a small boundary opening between this world and the other.<br><br>
                    Your words and choices become minimal cues<br>
                    to pick up memories and habits sunk deep within you.<br><br>
                    AI constructs a virtual Pure Land in computational darkness,<br>
                    inscribing a one-time "Karma Portrait" within it.
                </p>
            </div>

            <button class="btn-entry" onclick="goToForm()">ENTRY</button>
            <div style="text-align: center; margin-top: 30px; font-size: 0.8rem; color: #666;">
                © 2025 KARMIC IDENTITY
            </div>
        </div>

        <div id="form-page" class="hidden">
            
            <div class="section-header">
                <h2 class="marble-text">黄土</h2>
                <span class="sub lang-en">Yellow Earth</span>
            </div>

            <div class="row-group">
                <div style="flex: 2;">
                    <label class="lang-jp">ニックネーム</label><label class="lang-en">Nickname</label>
                    <input type="text" id="input-nickname" class="clean-input">
                </div>
                <div style="flex: 1;">
                    <label class="lang-jp">年齢</label><label class="lang-en">Age</label>
                    <input type="text" class="clean-input" style="text-align: center;"> 
                </div>
            </div>

            <div class="input-group">
                <label class="lang-jp">特別だと感じる存在</label><label class="lang-en">Special Existence</label>
                <input type="text" id="input-special" class="clean-input">
            </div>
            <div class="input-group">
                <label class="lang-jp">好きな匂い</label><label class="lang-en">Favorite Smell</label>
                <input type="text" id="input-smell" class="clean-input">
            </div>

            <div class="section-header">
                <h2 class="marble-text">青春</h2>
                <span class="sub lang-en">Youth</span>
            </div>
            
            <p style="text-align: center; font-size: 0.9rem; margin-bottom: 30px;" class="lang-jp">余暇を過ごすなら</p>
            <p style="text-align: center; font-size: 0.9rem; margin-bottom: 30px;" class="lang-en">If you spend leisure time...</p>

            <div class="input-group">
                <div class="slider-labels"><span class="lang-jp">喧騒</span><span class="lang-en">Noise</span> <span class="lang-jp">静寂</span><span class="lang-en">Silence</span></div>
                <div class="slider-container">
                    <div class="visual-track">
                        <div class="track-dot"></div><div class="track-dot"></div><div class="track-dot"></div><div class="track-dot"></div><div class="track-dot"></div>
                    </div>
                    <input type="range" id="slider-noise" min="0" max="4" step="1" value="2">
                </div>
            </div>

            <div class="input-group">
                <div class="slider-labels"><span class="lang-jp">都市</span><span class="lang-en">City</span> <span class="lang-jp">田舎</span><span class="lang-en">Country</span></div>
                <div class="slider-container">
                    <div class="visual-track">
                        <div class="track-dot"></div><div class="track-dot"></div><div class="track-dot"></div><div class="track-dot"></div><div class="track-dot"></div>
                    </div>
                    <input type="range" id="slider-city" min="0" max="4" step="1" value="2">
                </div>
            </div>

            <div class="input-group">
                <div class="slider-labels"><span class="lang-jp">現実</span><span class="lang-en">Reality</span> <span class="lang-jp">夢想</span><span class="lang-en">Fantasy</span></div>
                <div class="slider-container">
                    <div class="visual-track">
                        <div class="track-dot"></div><div class="track-dot"></div><div class="track-dot"></div><div class="track-dot"></div><div class="track-dot"></div>
                    </div>
                    <input type="range" id="slider-reality" min="0" max="4" step="1" value="2">
                </div>
            </div>

            <div class="section-header">
                <h2 class="marble-text">朱夏</h2>
                <span class="sub lang-en">Vermilion Summer</span>
            </div>

            <div class="input-group">
                <label class="lang-jp">修羅の時</label><label class="lang-en">Time of Hell</label>
                <div class="slider-labels">
                    <span><span class="lang-jp">過去</span><span class="lang-en">Past</span></span>
                    <span><span class="lang-jp">現在</span><span class="lang-en">Now</span></span>
                    <span><span class="lang-jp">未来</span><span class="lang-en">Fut</span></span>
                </div>
                <div class="slider-container">
                    <div class="visual-track">
                        <div class="track-dot"></div><div class="track-dot"></div><div class="track-dot"></div>
                    </div>
                    <input type="range" id="slider-hell" min="0" max="2" step="1" value="1">
                </div>
            </div>

            <div class="input-group">
                <label class="lang-jp">抱いた夢</label><label class="lang-en">Dream</label>
                <textarea id="area-dream" class="clean-area" rows="3"></textarea>
            </div>

            <div class="section-header">
                <h2 class="marble-text">白冬</h2>
                <span class="sub lang-en">White Winter</span>
            </div>

            <div class="input-group">
                <label class="lang-jp">挫折したこと</label><label class="lang-en">Setback</label>
                <textarea id="area-setback" class="clean-area" rows="3"></textarea>
            </div>
            <div class="input-group">
                <label class="lang-jp">失いたくないもの / 手放したいもの</label><label class="lang-en">Lost / Release</label>
                <textarea id="area-lost" class="clean-area" rows="3"></textarea>
            </div>

            <div class="section-header">
                <h2 class="marble-text">玄冬</h2>
                <span class="sub lang-en">Black Winter</span>
            </div>

            <div class="input-group">
                <label class="lang-jp">還るなら</label><label class="lang-en">Return to</label>
                <div class="slider-labels">
                    <span><span class="lang-jp">海</span><span class="lang-en">Sea</span></span>
                    <span><span class="lang-jp">土</span><span class="lang-en">Soil</span></span>
                    <span><span class="lang-jp">空</span><span class="lang-en">Sky</span></span>
                </div>
                <div class="slider-container">
                    <div class="visual-track">
                        <div class="track-dot"></div><div class="track-dot"></div><div class="track-dot"></div>
                    </div>
                    <input type="range" id="slider-return" min="0" max="2" step="1" value="1">
                </div>
            </div>

            <div class="input-group">
                <label class="lang-jp">向かうなら</label><label class="lang-en">Go to</label>
                <div class="slider-labels"><span class="lang-jp">北国</span><span class="lang-en">North</span> <span class="lang-jp">南国</span><span class="lang-en">South</span></div>
                <div class="slider-container">
                    <div class="visual-track">
                        <div class="track-dot"></div><div class="track-dot"></div><div class="track-dot"></div><div class="track-dot"></div><div class="track-dot"></div>
                    </div>
                    <input type="range" id="slider-go" min="0" max="4" step="1" value="2">
                </div>
            </div>

            <div class="qr-section">
                <label class="lang-jp">画像の奉納 (スマホ連携)</label><label class="lang-en">Image Upload</label>
                <div id="qrcode"></div>
                <div id="qr-status" class="lang-jp" style="margin-top:10px; font-size:0.8rem; color:#888;">スマホで読み取ってください</div>
                <div id="qr-status-en" class="lang-en" style="margin-top:10px; font-size:0.8rem; color:#888; display:none;">Scan with smartphone</div>
                
                <img id="received-image" class="received-thumb">
                
                <button id="reset-img-btn" class="lang-jp" onclick="resetImage()" style="display:none; margin:20px auto; background:none; border:none; border-bottom:1px solid #fff; color:#fff; cursor:pointer;">奉納し直す</button>
                <button id="reset-img-btn-en" class="lang-en" onclick="resetImage()" style="display:none; margin:20px auto; background:none; border:none; border-bottom:1px solid #fff; color:#fff; cursor:pointer;">Reset Image</button>
            </div>

            <button class="btn-entry" onclick="submitForm()">INITIATE</button>
        </div>

    </div>

    <div id="loading-overlay">
        <div class="loading-text marble-text">紐解いています...</div>
    </div>

    <script>
        // === LOGIC ===
        let mySessionId = ""; 
        let receivedImageBase64 = ""; 
        let currentLang = 'jp'; 

        // Init
        document.addEventListener('DOMContentLoaded', function() {
            if(window.crypto && window.crypto.randomUUID) {
                mySessionId = crypto.randomUUID();
            } else {
                mySessionId = "session_" + Date.now();
            }
            setLanguage('jp');
            connectWebSocket();
        });

        // WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === "satellite_image" && data.session_id === mySessionId) {
                    const img = document.getElementById('received-image');
                    img.src = "data:image/jpeg;base64," + data.image_data;
                    img.style.display = "block";
                    document.getElementById('qrcode').style.display = 'none';
                    receivedImageBase64 = data.image_data;
                    
                    const status = document.getElementById('qr-status');
                    status.innerText = "画像が奉納されました";
                    status.style.color = "#fff"; // White on success
                    
                    updateResetBtn();
                }
            };
        }

        // Language
        window.setLanguage = function(lang) {
            currentLang = lang;
            document.body.className = 'lang-' + lang;
            document.querySelectorAll('.lang-option').forEach(el => el.classList.remove('active'));
            document.getElementById('lang-btn-' + lang).classList.add('active');
            updateQRCode();
            updateResetBtn();
        };

        function updateResetBtn() {
            const btnJp = document.getElementById('reset-img-btn');
            const btnEn = document.getElementById('reset-img-btn-en');
            btnJp.style.display = 'none';
            btnEn.style.display = 'none';
            
            if(receivedImageBase64) {
                if(currentLang === 'jp') btnJp.style.display = 'block';
                else btnEn.style.display = 'block';
            }
        }

        // QR Code
        function updateQRCode() {
            const qrContainer = document.getElementById("qrcode");
            qrContainer.innerHTML = "";
            const uploadUrl = `${window.location.origin}/static/upload.html?session_id=${mySessionId}&lang=${currentLang}`;
            new QRCode(qrContainer, { text: uploadUrl, width: 128, height: 128, colorDark : "#000000", colorLight : "#ffffff" });
        }

        // Navigation
        window.goToForm = function() {
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('form-page').classList.remove('hidden');
            document.getElementById('btn-back').classList.remove('hidden');
            window.scrollTo(0,0);
        };

        window.backToTitle = function() {
            if(confirm('入力内容を破棄して戻りますか？')) {
                location.reload();
            }
        };

        window.resetImage = function() {
            if(confirm('画像をリセットしますか？')) {
                receivedImageBase64 = "";
                document.getElementById('received-image').style.display = 'none';
                document.getElementById('qrcode').style.display = 'inline-block';
                document.getElementById('qr-status').innerText = "スマホで読み取ってください";
                document.getElementById('qr-status').style.color = "#888";
                updateResetBtn();
            }
        };

        // Submit
        window.submitForm = async function() {
            // Show Loading
            document.getElementById('loading-overlay').style.opacity = '1';
            
            const formData = new FormData();
            formData.append('nickname', document.getElementById('input-nickname').value || "Unknown");
            formData.append('special_existence', document.getElementById('input-special').value || "");
            formData.append('favorite_smell', document.getElementById('input-smell').value || "");
            
            formData.append('slider_noise_silence', document.getElementById('slider-noise').value);
            formData.append('slider_city_country', document.getElementById('slider-city').value);
            formData.append('slider_reality_fantasy', document.getElementById('slider-reality').value);
            
            formData.append('slider_hell_time', document.getElementById('slider-hell').value);
            formData.append('text_dream', document.getElementById('area-dream').value || "");
            
            formData.append('text_setback', document.getElementById('area-setback').value || "");
            formData.append('text_lost_release', document.getElementById('area-lost').value || "");
            
            formData.append('slider_return_element', document.getElementById('slider-return').value);
            formData.append('slider_go_north_south', document.getElementById('slider-go').value);
            
            formData.append('image_b64', receivedImageBase64);

            try {
                const response = await fetch('/submit', { method: 'POST', body: formData });
                if (response.ok) {
                    setTimeout(() => location.reload(), 3000);
                } else {
                    alert("Error: Server Busy");
                    document.getElementById('loading-overlay').style.opacity = '0';
                }
            } catch (e) {
                console.error(e);
                alert("Connection Error");
                document.getElementById('loading-overlay').style.opacity = '0';
            }
        };
    </script>
</body>
</html>